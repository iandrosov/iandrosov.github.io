---
layout: post
title: Deploy Salesforce Communities via ANT Migration Tool
---
Update 10/23/2018

If you recently worked with Salesforce Communities it is not easy to deploy or move to different environments. Here we will show how to use ANT script to deploy Community and manage source in GitHub.

Based on what I learned from Salesforce one reason it is not easy to deploy Community is its design. Communities Team initially expected Enterprises will be making changes and building Community direct in Production and then move it to sanboxes using refresh sandbox feature. Going down from PROD to other QA/UAT environment distribution model. The Production org is expected as source of trueth. However, reality of develpment is most processes start in DEV sandbox and expected to move through multiple test stages like QA, UAT, and then PROD. Understandig this requirements Salesforce is working to change the initial idea and make community more source driven  with metadata and DX. That is a need that has been recognized and hopefully is comming in some later releases.

For now we need to deal with current state and try to deploy our Community from DEV to QA sandbox and later to Production.
We start with existing community we already built with all configs, pages, and Lightning components etc. Assume we have all that. Our next step is to export all this customization and development into source control, in our case GitHub and deploy to target Organization - QA or Production.

### Extract Communities Metadata

We need to make a `package.xml` file for this and not much documentation available on this so I add this here
Our community may consist of many diferent metadata artifacts, VF Pages, Configs settings, Ligtning Components, APEX classes and other things. Metadata for APEX code, Lightning `aura` components are well documneted and known to most develpers.
Note here we are dealing with new API Version 44.00 Winter 19 for `ant.salesforce.jar`

We will focus here on Community itself that is stored in these various metadata components
 
+ `Network` - Community settings XML file
+ `CustomSite` - Associated site settings XML file
+ `SiteDotCom` - Site content, binary blob autogenerated for community
+ `Audience` - Bult audiences added in recent releses
+ `NetworkBranding` - brannding parammeters for a main site (does not include page variantions) and need to prefix `cb<Name>`

Possibly Page variants ae support I just did not see detailed docs and could not reveres engeneer how to get these items yet.
We start our `package.xml` with these Communities components. Our Community name was `ECom` as an example.

```
<?xml version="1.0" encoding="UTF-8"?>
<Package xmlns="http://soap.sforce.com/2006/04/metadata">
    <types>
        <members>ECom</members>
        <name>CustomSite</name>
    </types>
    <types>
        <members>ECom</members>
        <name>Network</name>
    </types>
    <types>
        <members>ECom_C</members>
        <name>SiteDotCom</name>
    </types>
    <types>
        <members>A_Faculty</members>
        <members>B_Faculty</members>
        <members>C_Faculty</members>
        <name>Audience</name>
    </types>
    <types>
        <members>cbECOM_Community</members>
        <name>NetworkBranding</name>
    </types>    
    <version>44.0</version>
</Package>
``` 

Notice `SiteDotCom` name `ECom_C` initially I was not aware this component was there untill I try to deploy got this error from ant.

```
networks/ECom.network -- Error: In field: PicassoSite - no SiteDotCom named ECom_C found
```
Added this component, aparently it is auto generated for each Community, This file is stored in a form of large binary blob that represents various content in our Communities and meta xml file. Incidentatly this blob also holds Builder Page configuartions (site pages that seem to be cached for environment). Why this is IMPORATNT I will explain this later.

```
<?xml version="1.0" encoding="UTF-8"?>
<SiteDotCom xmlns="http://soap.sforce.com/2006/04/metadata">
    <label>ECom</label>
    <siteType>ChatterNetworkPicasso</siteType>
</SiteDotCom>

```

CustomSite is XML file describes Force.com Site associated to each Community and automatically created when Community is created.

```
<?xml version="1.0" encoding="UTF-8"?>
<CustomSite xmlns="http://soap.sforce.com/2006/04/metadata">
    <active>true</active>
    <allowHomePage>false</allowHomePage>
    <allowStandardAnswersPages>false</allowStandardAnswersPages>
    <allowStandardIdeasPages>false</allowStandardIdeasPages>
    <allowStandardLookups>false</allowStandardLookups>
    <allowStandardPortalPages>true</allowStandardPortalPages>
    <allowStandardSearch>false</allowStandardSearch>
    <authorizationRequiredPage>EXT_CommunitiesLoginPage</authorizationRequiredPage>
    <bandwidthExceededPage>EXT_CommunityMaintenanceErrorPage</bandwidthExceededPage>
    <changePasswordPage>EXT_ResetPassword</changePasswordPage>
    <clickjackProtectionLevel>SameOriginOnly</clickjackProtectionLevel>
    <fileNotFoundPage>EXT_CommunityNotFoundErrorPage</fileNotFoundPage>
    <genericErrorPage>EXT_CommunityNotFoundErrorPage</genericErrorPage>
    <inMaintenancePage>EXT_CommunityMaintenanceErrorPage</inMaintenancePage>
    <inactiveIndexPage>CommunitiesLogin</inactiveIndexPage>
    <indexPage>CommunitiesLogin</indexPage>
    <masterLabel>ECom</masterLabel>
    <requireHttps>true</requireHttps>
    <requireInsecurePortalAccess>false</requireInsecurePortalAccess>
    <siteAdmin>my-admin@email.com</siteAdmin>
    <siteType>ChatterNetwork</siteType>
    <subdomain>communitydev</subdomain>
    <urlPathPrefix>ecom</urlPathPrefix>
</CustomSite>

```

Now that we have our metadata files we  can use ant to deploy Community to our target org. Once we run ant command 'ant deployQA' as an example and if it is a success we can see all our community elements in target org. Site, Community are in new org, we can also see Admin side has our configs. All seem to be good. Now lets try Community Builder pages and our components. Open Builder... oh oh we get some JavaScript error.

![Community Builder error]({{ site.baseurl }}/images/communitydeploy/cberror.png)

Support's answer to this is to refresh Community template. Aparently, this issue is possibly caused by a "caching" (in Salesforce) issue after deployment, (possibly that Site.com BLOB I mentioned earlier). In order to resolve this issue, we will need to switch the Community Template to Salesforce Tabs + Visualforce then switch it back to Napili Template. Using following steps below: 

1. Go to Setup > Customize > Communities > All Communities. 
2. Click Manage. 
3. Go to Administration > Settings. 
4. Click Change Template. 
5. Click Salesforce Tabs + Visualforce. 
6. Click Get Started. 
7. Enter the Name and URL then click Create. 
8. Click Manage & Moderate. 
9. Go back to Administration > Settings. 
10. Click Change Template. 
11. Click Customer Service (Napili). 
12. Click Get Started. 
13. Enter the Name & URL then click Create. 
14. Click Build & Customize. 

We can do this and it will fix the Community Builder access, but all our custom page configurations and site tempalte layouts will be lost. It is basically saying to almost flush your Community site pages and build a new site. If it is simple Napili with default pages that will not be a problem. In our case, we had a custom template layout, custom look UI, custom Builder pages all that will need to be rebuilt. I think that is most common use of Communities today. It is not a very detail CSS/HTML level rebuild but Community Builder drag-drop kind of a build but still lots of details in pages and component properties need to be managed. This makes it difficult if not impossible to store Community in source control for distribution or CI/CD.

Conclusion, while deploying Community is made possible with metadata API `Network metadata component` not everything can be handled by this method. When we need a complete custom looking community it may be better to package it as custom Community Template with pages and distribute it this way. I will have to try that method next and see how that works.
Will also need to look at DX-Community deployment option may be a way to handle this in teh future.

